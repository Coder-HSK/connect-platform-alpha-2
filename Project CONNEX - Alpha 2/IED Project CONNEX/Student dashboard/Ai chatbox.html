<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Chatbot | CONNEX</title>
  <!-- Google Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="stylesheet" href="../../Style/Style1.css">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  
</head>
<body>

 <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="container">
            <div class="logo">
                <h1><a href="../../index.html" class="logo">CONNEX</a></h1>

            </div>
            <ul class="nav-links">
              <li><a href="../Student-dashboard.html" class="btnk-primary">Home</a></li>
              <li><a href="../Student premium.html" class="btnk-primary">Premium</a></li>
            </ul>
            <div class="cta-button">
                <a href="account.html" class="btn-primary">Account</a>
            </div>
        </div>
    </nav>

  <!-- Main Chat Content -->
  <main>
    <section class="dashboard-hero">
      <div class="container">
        <h1 class="dashboard-title">Ask CONNEX AI</h1>
        <p class="dashboard-tagline">Ask anything about the job market. Our AI chatbot trained with real-time market data will answer all your queries.</p>
      </div>
    </section>

    <div class="chat-container">
      <div class="chat-messages" id="chat-messages">
        <!-- Example bot welcome message -->
        <div class="message bot">
          Hello! I'm the CONNEX AI assistant. How can I help you with your career or job search today?
        </div>
      </div>
      <div class="chat-input-bar">
        <input type="text" id="chat-input" placeholder="Ask about resumes, interviews, or market trends...">
        <button id="send-button">Send</button>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
        <div class="footer-content">
            <div class="footer-section">
                <h3>CONNEX</h3>
                <p>Building bridges between students and professionals.</p>
            </div>
            <div class="footer-section">
                <h4>Quick Links</h4>
                <ul>
                    <li><a href="#home">Home</a></li>
                    <li><a href="#about">About</a></li>
                    <li><a href="#how-it-works">How It Works</a></li>
                    <li><a href="#contact">Contact</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h4>Project by:</h4>
                <ul>
                    <li>Hitendra Annavarapu</li>
                    <li>Mahadi Ibrahim</li>
                    <li>Quin Curry</li>
                    <li>Charan Suguri</li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2025 CONNEX Platform - Alpha 2. All rights reserved.</p>
        </div>
    </div>
  </footer>

  <!-- JAVASCRIPT TO POWER THE CHATBOT -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Get chat elements
      const chatMessages = document.getElementById('chat-messages');
      const chatInput = document.getElementById('chat-input');
      const sendButton = document.getElementById('send-button');

      // --- Add event listeners ---
      sendButton.addEventListener('click', sendMessage);
      chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          sendMessage();
        }
      });

      // --- System instruction for the bot ---
      const systemPrompt = `You are CONNEX, an expert AI assistant for students and recruiters, specializing in the job market, career advice, and skill building. You are trained with real-time market data.
      Keep your answers concise, professional, and helpful.
      Format your responses using simple markdown (bold, italics, lists) for readability.
      You MUST NOT answer questions unrelated to jobs, careers, education, or professional development.`;
      
      /**
       * Adds a new message to the chat log
       * @param {string} text - The message text
       * @param {string} sender - 'user' or 'bot'
       * @returns {HTMLElement} - The message element that was just added
       */
      function addMessageToLog(text, sender) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('message', sender);
        
        // A simple markdown-to-HTML converter
        let html = text
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold
          .replace(/\*(.*?)\*/g, '<em>$1</em>')     // Italics
          .replace(/\n\* (.*)/g, '<ul><li>$1</li></ul>') // Basic lists
          .replace(/<\/ul><ul>/g, ''); // Fix for consecutive list items
          
        messageElement.innerHTML = html;
        chatMessages.appendChild(messageElement);
        
        // Scroll to the bottom
        chatMessages.scrollTop = chatMessages.scrollHeight;
        return messageElement;
      }

      /**
       * Shows the "bot is typing..." loading indicator
       */
      function showLoadingIndicator() {
        const loadingElement = document.createElement('div');
        loadingElement.classList.add('message', 'bot', 'loading');
        loadingElement.id = 'loading-indicator';
        loadingElement.innerHTML = `
          <div class="loading-dot"></div>
          <div class="loading-dot"></div>
          <div class="loading-dot"></div>
        `;
        chatMessages.appendChild(loadingElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      /**
       * Removes the "bot is typing..." loading indicator
       */
      function hideLoadingIndicator() {
        const loadingElement = document.getElementById('loading-indicator');
        if (loadingElement) {
          chatMessages.removeChild(loadingElement);
        }
      }
      
      /**
       * Formats and appends source citations to a bot message
       * @param {HTMLElement} botMessageElement - The bot's message bubble
       * @param {Array} sources - The array of source objects from groundingMetadata
       */
      function appendSources(botMessageElement, sources) {
        if (!sources || sources.length === 0) {
          return;
        }

        const sourcesContainer = document.createElement('div');
        sourcesContainer.classList.add('sources');
        
        let sourcesHtml = '<h4>Sources:</h4><ol>';
        sources.forEach((source, index) => {
          sourcesHtml += `<li><a href="${source.uri}" target="_blank">${source.title || 'Source ' + (index + 1)}</a></li>`;
        });
        sourcesHtml += '</ol>';
        
        sourcesContainer.innerHTML = sourcesHtml;
        botMessageElement.appendChild(sourcesContainer);
      }

      /**
       * Main function to handle sending a message
       */
      async function sendMessage() {
        const userQuery = chatInput.value.trim();
        if (!userQuery) return;

        // Disable input while processing
        chatInput.value = '';
        chatInput.disabled = true;
        sendButton.disabled = true;

        // 1. Add user's message to log
        addMessageToLog(userQuery, 'user');

        // 2. Show loading indicator
        showLoadingIndicator();

        try {
          // 3. Call the Gemini API
          const { text, sources } = await callGeminiApi(userQuery);
          
          // 4. Hide loading and show bot's response
          hideLoadingIndicator();
          const botMessageElement = addMessageToLog(text, 'bot');
          
          // 5. Add sources, if any
          appendSources(botMessageElement, sources);

        } catch (error) {
          // Handle errors
          hideLoadingIndicator();
          addMessageToLog('Sorry, I ran into an error. Please try again.', 'bot');
        }

        // Re-enable input
        chatInput.disabled = false;
        sendButton.disabled = false;
        chatInput.focus();
      }

      /**
       * Calls the Gemini API with retry logic
       * @param {string} userQuery - The user's prompt
       * @returns {Promise<{text: string, sources: Array}>} - The bot's response text and sources
       */
      async function callGeminiApi(userQuery) {
        // IMPORTANT: The API key is an empty string. The Canvas environment
        // will securely provide the key at runtime. DO NOT PASTE YOUR KEY HERE.
        const apiKey = "AIzaSyD7yff-vHibNIRAS5UuaXnL-qLOQEuOoBk"; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // Payload with grounding (Google Search) enabled
        const payload = {
          contents: [{ parts: [{ text: userQuery }] }],
          tools: [{ "google_search": {} }],
          systemInstruction: {
            parts: [{ text: systemPrompt }]
          },
        };

        let response;
        let retries = 3;
        let delay = 1000; // 1 second

        // Retry logic with exponential backoff
        for (let i = 0; i < retries; i++) {
          try {
            response = await fetch(apiUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });

            if (response.ok) {
              const result = await response.json();
              const candidate = result.candidates?.[0];

              if (candidate && candidate.content?.parts?.[0]?.text) {
                // 1. Extract the generated text
                const text = candidate.content.parts[0].text;

                // 2. Extract grounding sources
                let sources = [];
                const groundingMetadata = candidate.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri); // Ensure sources are valid
                }
                
                return { text, sources };
              } else {
                throw new Error('Invalid API response structure');
              }
            } else if (response.status === 429 || response.status >= 500) {
              // Throttling or server error, wait and retry
              await new Promise(resolve => setTimeout(resolve, delay));
              delay *= 2; // Exponential backoff
            } else {
              // Other client-side error, don't retry
              const errorResult = await response.json();
              console.error('API Error:', errorResult);
              throw new Error(errorResult.error?.message || `HTTP error! status: ${response.status}`);
            }
          } catch (error) {
            if (i === retries - 1) {
              // Last retry failed
              console.error('API call failed after retries:', error);
              throw new Error('API call failed. Please try again later.');
            }
            // Wait before retrying
            await new Promise(resolve => setTimeout(resolve, delay));
            delay *= 2;
          }
        }
        
        throw new Error('API call failed after all retries.');
      }
    });
  </script>
</body>
</html>