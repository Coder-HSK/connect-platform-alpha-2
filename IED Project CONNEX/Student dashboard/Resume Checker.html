<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Resume Analyzer | CONNEX</title>
  <!-- Google Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="../../Style/Style1.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  
</head>
<body>

 <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="container">
            <div class="logo">
                <h1><a href="../../index.html" class="logo">CONNEX</a></h1>

            </div>
            <ul class="nav-links">
              <li><a href="../Student-dashboard.html" class="btnk-primary">Home</a></li>
              <li><a href="../Student premium.html" class="btnk-primary">Premium</a></li>
            </ul>
            <div class="cta-button">
                <a href="account.html" class="btn-primary">Account</a>
            </div>
        </div>
    </nav>

  <!-- Main Content -->
  <main>
    <section class="dashboard-hero">
      <div class="container">
        <h1 class="dashboard-title">AI Resume Analyzer</h1>
        <p class="dashboard-tagline">Paste your resume text below to get an AI-powered analysis, a score out of 100, and actionable feedback.</p>
      </div>
    </section>

    <div class="analyzer-layout container">
      <!-- Left Side: Input -->
      <div class="resume-input-area glass-card">
        <h2>Upload or Paste Your Resume</h2>
        
        <!-- The input is now hidden by CSS -->
        <input type="file" id="resume-file" accept=".pdf,.docx">
        
        <!-- The label, linked by 'for', will trigger the hidden input -->
        <div class="file-input-wrapper">
          <label for="resume-file" class="file-input-button">
            <span>Click to Upload File</span>
            <p>(.pdf or .docx only)</p>
          </label>
        </div>
        
        <!-- NEW: Text to show the selected filename -->
        <p id="file-name-display"></p>
        
        <textarea id="resume-text" placeholder="...or paste the entire text of your resume here..."></textarea>
        <button id="analyze-button">Analyze My Resume</button>
      </div>

      <!-- Right Side: Output -->
      <div class="analysis-output-area glass-card">
        <h2>Your Analysis</h2>
        
        <!-- Initial Placeholder -->
        <div id="results-placeholder">
          Your score and feedback will appear here.
        </div>
        
        <!-- Loading State -->
        <div id="results-loading">
          Analyzing... This may take a moment.
        </div>
        
        <!-- Error State -->
        <div id="results-error">
          Sorry, an error occurred. Please try again.
        </div>

        <!-- Results Content -->
        <div id="results-content">
          <div class="score-container">
            <div class="score-circle" id="score-circle">...</div>
            <span>Overall Score</span>
          </div>
          
          <div class="results-section">
            <h3>Overall Summary</h3>
            <p id="results-summary"></p>
          </div>
          
          <div class="results-section">
            <h3>What's Working Well</h3>
            <ul id="results-good"></ul>
          </div>
          
          <div class="results-section">
            <h3>Areas for Improvement</h3>
            <ul id="results-improvements"></ul>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
        <div class="footer-content">
            <div class="footer-section">
                <h3>CONNEX</h3>
                <p>Building bridges between students and professionals.</p>
            </div>
            <div class="footer-section">
                <h4>Quick Links</h4>
                <ul>
                    <li><a href="#home">Home</a></li>
                    <li><a href="#about">About</a></li>
                    <li><a href="#how-it-works">How It Works</a></li>
                    <li><a href="#contact">Contact</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h4>Project by:</h4>
                <ul>
                    <li>Hitendra Annavarapu</li>
                    <li>Mahadi Ibrahim</li>
                    <li>Quin Curry</li>
                    <li>Charan Suguri</li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2025 CONNEX Platform - Alpha 2. All rights reserved.</p>
        </div>
    </div>
  </footer>

  <!-- NEW SCRIPT LIBRARIES FOR FILE PARSING -->
  <!-- IMPORTANT: Must come before the main script -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.18/mammoth.browser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
  
  <script>
    // Set up PDF.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';
  
    document.addEventListener('DOMContentLoaded', function() {
      // --- Get all UI elements ---
      const analyzeButton = document.getElementById('analyze-button');
      const resumeText = document.getElementById('resume-text');
      const resumeFileInput = document.getElementById('resume-file');
      const fileNameDisplay = document.getElementById('file-name-display'); // NEW
      
      const resultsPlaceholder = document.getElementById('results-placeholder');
      const resultsLoading = document.getElementById('results-loading');
      const resultsError = document.getElementById('results-error');
      const resultsContent = document.getElementById('results-content');
      
      const scoreCircle = document.getElementById('score-circle');
      const resultsSummary = document.getElementById('results-summary');
      const resultsGood = document.getElementById('results-good');
      const resultsImprovements = document.getElementById('results-improvements');
      
      // --- NEW: File Upload Handler ---
      resumeFileInput.addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (!file) {
          fileNameDisplay.textContent = '';
          return;
        }
        
        // NEW: Display the selected filename
        fileNameDisplay.textContent = `Selected file: ${file.name}`;

        // Get file extension
        const extension = file.name.split('.').pop().toLowerCase();
        
        // Show loading state in text box
        resumeText.value = 'Parsing file... please wait...';
        analyzeButton.disabled = true;

        const reader = new FileReader();

        reader.onload = function(e) {
          const arrayBuffer = e.target.result;

          if (extension === 'pdf') {
            // --- Parse PDF ---
            pdfjsLib.getDocument({ data: arrayBuffer }).promise.then(function(pdf) {
              let allText = '';
              let pagePromises = [];
              
              for (let i = 1; i <= pdf.numPages; i++) {
                pagePromises.push(
                  pdf.getPage(i).then(function(page) {
                    return page.getTextContent();
                  }).then(function(textContent) {
                    return textContent.items.map(item => item.str).join(' ');
                  })
                );
              }
              
              Promise.all(pagePromises).then(function(pagesText) {
                resumeText.value = pagesText.join('\n\n'); // Join all pages
                analyzeButton.disabled = false;
              });
              
            }).catch(err => {
              resumeText.value = 'Error parsing PDF. Please paste text manually.';
              fileNameDisplay.textContent = 'Error parsing PDF.';
              analyzeButton.disabled = false;
            });

          } else if (extension === 'docx') {
            // --- Parse DOCX ---
            mammoth.extractRawText({ arrayBuffer: arrayBuffer })
              .then(function(result) {
                resumeText.value = result.value; // The extracted text
                analyzeButton.disabled = false;
              })
              .catch(function(err) {
                resumeText.value = 'Error parsing .docx file. Please paste text manually.';
                fileNameDisplay.textContent = 'Error parsing .docx file.';
                analyzeButton.disabled = false;
              });
          } else {
            resumeText.value = 'Error: Unsupported file type. Please use .pdf or .docx, or paste text.';
            fileNameDisplay.textContent = 'Error: Unsupported file type.';
          }
        };
        
        reader.readAsArrayBuffer(file);
      });

      // --- Analyze Button Click Handler (Existing Logic) ---
      analyzeButton.addEventListener('click', function() {
        const resume = resumeText.value.trim();
        if (!resume || resume === 'Parsing file... please wait...') {
          // Use a modal or better UI element in production
          alert('Please paste or upload your resume first.');
          return;
        }

        // --- Set UI states ---
        resultsPlaceholder.style.display = 'none';
        resultsContent.style.display = 'none';
        resultsError.style.display = 'none';
        resultsLoading.style.display = 'flex';
        analyzeButton.disabled = true;

        // --- Call Gemini API ---
        callGeminiApi(resume);
      });

      /**
       * Shows the final results in the UI
       * @param {object} analysis - The parsed JSON object from the AI
       */
      function showResults(analysis) {
        // 1. Update Score
        const scorePercentage = parseInt(analysis.score) || 0;
        scoreCircle.textContent = scorePercentage;
        // Dynamic conic-gradient for the score
        scoreCircle.style.background = `conic-gradient(#00ffea ${scorePercentage * 3.6}deg, #0a192f ${scorePercentage * 3.6}deg 0deg)`;


        // 2. Update Summary
        resultsSummary.textContent = analysis.summary;

        // 3. Update Good List
        resultsGood.innerHTML = ''; // Clear old results
        analysis.good.forEach(item => {
          const li = document.createElement('li');
          li.textContent = item;
          resultsGood.appendChild(li);
        });

        // 4. Update Improvements List
        resultsImprovements.innerHTML = ''; // Clear old results
        analysis.improvements.forEach(item => {
          const li = document.createElement('li');
          li.textContent = item;
          resultsImprovements.appendChild(li);
        });

        // 5. Show the results
        resultsLoading.style.display = 'none';
        resultsContent.style.display = 'block';
        analyzeButton.disabled = false;
      }

      /**
       * Calls the Gemini API with structured JSON response
       * @param {string} resumeText - The user's resume text
       */
      async function callGeminiApi(resumeText) {
        // --- API and System Prompt ---
        const apiKey = "AIzaSyD7yff-vHibNIRAS5UuaXnL-qLOQEuOoBk"; // Key from user
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        const systemPrompt = `You are an expert, professional resume reviewer for the CONNEX platform.
        You will analyze the user's resume text and provide a score and feedback in a specific JSON format.
        The score must be an integer between 50 and 100.
        The summary must be a concise, 2-3 sentence overview.
        The 'good' and 'improvements' arrays must contain at least 3 bullet points each.
        Focus on action verbs, quantifiable achievements, formatting clarity, and keyword optimization.`;

        // --- JSON Schema for the response ---
        const responseSchema = {
          type: "OBJECT",
          properties: {
            "score": { "type": "NUMBER" },
            "summary": { "type": "STRING" },
            "good": {
              "type": "ARRAY",
              "items": { "type": "STRING" }
            },
            "improvements": {
              "type": "ARRAY",
              "items": { "type": "STRING" }
            }
          },
          required: ["score", "summary", "good", "improvements"]
        };

        const payload = {
          contents: [{
            parts: [{ text: `Here is my resume text. Please analyze it:\n\n${resumeText}` }]
          }],
          systemInstruction: {
            parts: [{ text: systemPrompt }]
          },
          generationConfig: {
            responseMimeType: "application/json",
            responseSchema: responseSchema,
            temperature: 0.5,
          }
        };

        try {
          // --- Fetch from API ---
          let response;
          let retries = 3;
          let delay = 1000;

          for (let i = 0; i < retries; i++) {
            response = await fetch(apiUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });

            if (response.ok) {
              break; // Success
            } else if (response.status === 429 || response.status >= 500) {
              await new Promise(resolve => setTimeout(resolve, delay));
              delay *= 2;
            } else {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
          }

          if (!response.ok) {
            throw new Error(`API call failed after ${retries} retries.`);
          }

          const result = await response.json();
          const candidate = result.candidates?.[0];

          if (candidate && candidate.content?.parts?.[0]?.text) {
            const jsonText = candidate.content.parts[0].text;
            const analysis = JSON.parse(jsonText);
            showResults(analysis);
          } else {
            throw new Error('Invalid API response structure');
          }

        } catch (error) {
          console.error('API call failed:', error);
          resultsLoading.style.display = 'none';
          resultsError.style.display = 'flex';
          analyzeButton.disabled = false;
        }
      }
    });
  </script>
</body>
</html>