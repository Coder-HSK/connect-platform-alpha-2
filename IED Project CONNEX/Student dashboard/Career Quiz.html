<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Career Quiz | CONNEX</title>
  <!-- Google Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="stylesheet" href="../../Style/Style1.css">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">


</head>
<body>

    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="container">
            <div class="logo">
                <h1><a href="../../index.html" class="logo">CONNEX</a></h1>

            </div>
            <ul class="nav-links">
              <li><a href="../Student-dashboard.html" class="btnk-primary">Home</a></li>
              <li><a href="../Student premium.html" class="btnk-primary">Premium</a></li>
            </ul>
            <div class="cta-button">
                <a href="account.html" class="btn-primary">Account</a>
            </div>
        </div>
    </nav>

  <main>
    <div class="container">
      <div class="quiz-container">
        
        <!-- Quiz Box -->
        <div id="quiz-box">
          <h2 class="quiz-question" id="quiz-question-text">Loading...</h2>
          <div class="quiz-options" id="quiz-options-container">
            <!-- Options will be dynamically inserted here -->
          </div>
        </div>

        <!-- Results Box -->
        <div id="results-box">
          <h2 class="results-title" id="results-title-text">Your Career Profile</h2>
          <!-- Loading State -->
          <div id="loading-spinner"></div>
          <p id="loading-text">Analyzing your results...</p>
          
          <!-- Content to be shown after loading -->
          <div id="results-content">
            <p class="results-subtitle" id="results-subtitle-text">Based on your answers, here is a career path that matches your interests:</p>
            <h3 class="results-careers" id="results-careers-text">[Career Examples]</h3>
            <p class="results-description" id="results-description-text">[Brief Description]</p>
            <div class="results-details">
              <strong>Education:</strong>
              <span id="results-education-text">[Education]</span>
              <strong>Median Salary:</strong>
              <span id="results-salary-text">[Median Salary]</span>
              <strong>Work Environment:</strong>
              <span id="results-environment-text">[Work Environment]</span>
            </div>
          </div>
          <button class="sign-btn" id="restart-quiz-btn">Take Quiz Again</button>
        </div>

      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-section">
          <h3>CONNEX</h3>
          <p>Building bridges between students and professionals.</p>
        </div>
        <div class="footer-section">
          <h4>Quick Links</h4>
          <ul>
            <li><a href="#home">Home</a></li>
            <li><a href="#about">About</a></li>
            <li><a href="#how-it-works">How It Works</a></li>
            <li><a href="#contact">Contact</a></li>
          </ul>
        </div>
        <div class="footer-section">
          <h4>Project by:</h4>
          <ul>
            <li>Hitendra Annavarapu</li>
            <li>Mahadi Ibrahim</li>
            <li>Quin Curry</li>
            <li>Charan Suguri</li>
          </ul>
        </div>
      </div>
      <div class="footer-bottom">
        <p>&copy; 2025 CONNEX Platform - Alpha 2. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <!-- JAVASCRIPT FOR QUIZ LOGIC -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {

      // --- API Configuration ---
      // IMPORTANT: The API key is left empty. Your environment will provide this.
      const apiKey = "AIzaSyD7yff-vHibNIRAS5UuaXnL-qLOQEuOoBk"; 
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

      // --- 1. DEFINE QUIZ QUESTIONS (from career_finder_quiz_tree.md) ---
      const questions = {
        'Q1': {
          text: 'What type of work environment appeals to you most?',
          options: [
            { text: 'Hands-on work with tools, machines, or outdoor settings', next: 'Q2', choice: 'A' },
            { text: 'Research-oriented, analytical, or scientific work', next: 'Q3', choice: 'B' },
            { text: 'Creative, expressive, or artistic settings', next: 'Q4', choice: 'C' },
            { text: 'Helping people, teaching, or counseling', next: 'Q5', choice: 'D' },
            { text: 'Leading teams, selling, or business management', next: 'Q6', choice: 'E' },
            { text: 'Organized office work with data and procedures', next: 'Q7', choice: 'F' }
          ]
        },
        'Q2': {
          text: 'Which hands-on activity interests you?',
          options: [
            { text: 'Building, constructing, or repairing structures', next: 'Q8', choice: 'A' },
            { text: 'Vehicles, machinery, or mechanical systems', next: 'Q8', choice: 'B' },
            { text: 'Agriculture/animals/nature', next: 'Q8', choice: 'C' },
            { text: 'Electronics, equipment, or precision tools', next: 'Q8', choice: 'D' }
          ]
        },
        'Q3': {
          text: 'Which analytical field?',
          options: [
            { text: 'Life sciences/medical/biology', next: 'Q9', choice: 'A' },
            { text: 'Physical/chemistry/physics', next: 'Q9', choice: 'B' },
            { text: 'Computers/data/math', next: 'Q9', choice: 'C' },
            { text: 'Psychology/social research', next: 'Q9', choice: 'D' }
          ]
        },
        'Q4': {
          text: 'Creative domain?',
          options: [
            { text: 'Visual arts/design/photography', next: 'Q10', choice: 'A' },
            { text: 'Writing/journalism/content', next: 'Q10', choice: 'B' },
            { text: 'Performing arts/music/entertainment', next: 'Q10', choice: 'C' },
            { text: 'Fashion/interior/product design', next: 'Q10', choice: 'D' }
          ]
        },
        'Q5': {
          text: 'Preferred way to help?',
          options: [
            { text: 'Healthcare/nursing/medicine', next: 'Q11', choice: 'A' },
            { text: 'Teaching/education', next: 'Q11', choice: 'B' },
            { text: 'Counseling/therapy', next: 'Q11', choice: 'C' },
            { text: 'Community/social services', next: 'Q11', choice: 'D' }
          ]
        },
        'Q6': {
          text: 'Business angle?',
          options: [
            { text: 'Sales/persuasion/deals', next: 'Q12', choice: 'A' },
            { text: 'Managing/operations', next: 'Q12', choice: 'B' },
            { text: 'Entrepreneurship/startups', next: 'Q12', choice: 'C' },
            { text: 'Marketing/advertising', next: 'Q12', choice: 'D' }
          ]
        },
        'Q7': {
          text: 'Structured work?',
          options: [
            { text: 'Accounting/finance/audit', next: 'Q13', choice: 'A' },
            { text: 'Office management/admin', next: 'Q13', choice: 'B' },
            { text: 'Data/record keeping', next: 'Q13', choice: 'C' },
            { text: 'Legal/compliance', next: 'Q13', choice: 'D' }
          ]
        },
        'Q8': {
          text: 'How do you prefer to work?',
          options: [
            { text: 'Independently/minimal interaction', next: 'Q14', choice: 'A' },
            { text: 'In small teams/some collaboration', next: 'Q14', choice: 'B' },
            { text: 'Large teams/frequent interaction', next: 'Q14', choice: 'C' }
          ]
        },
        'Q9': {
          text: 'Problem-solving style:',
          options: [
            { text: 'Established methods', next: 'Q14', choice: 'A' },
            { text: 'Balance innovation/practical', next: 'Q14', choice: 'B' },
            { text: 'Novel/experimental approaches', next: 'Q14', choice: 'C' }
          ]
        },
        'Q10': {
          text: 'Creative process:',
          options: [
            { text: 'Client/market-driven', next: 'Q14', choice: 'A' },
            { text: 'Balance personal/commercial', next: 'Q14', choice: 'B' },
            { text: 'Pure expression/experimentation', next: 'Q14', choice: 'C' }
          ]
        },
        'Q11': {
          text: 'Handling difficult situations:',
          options: [
            { text: 'Direct confrontation', next: 'Q15', choice: 'A' },
            { text: 'Diplomacy/empathy', next: 'Q15', choice: 'B' },
            { text: 'Harmony/understanding', next: 'Q15', choice: 'C' }
          ]
        },
        'Q12': {
          text: 'Energizer in business:',
          options: [
            { text: 'Strategy/independent planning', next: 'Q15', choice: 'A' },
            { text: 'Collaboration/teams', next: 'Q15', choice: 'B' },
            { text: 'Networking/presenting', next: 'Q15', choice: 'C' }
          ]
        },
        'Q13': {
          text: 'Managing deadlines:',
          options: [
            { text: 'Adapt priorities/flexible', next: 'Q15', choice: 'A' },
            { text: 'Structured planning w/ adjustments', next: 'Q15', choice: 'B' },
            { text: 'Strict schedule/adherence', next: 'Q15', choice: 'C' }
          ]
        },
        'Q14': {
          text: 'Work schedule:',
          options: [
            { text: 'Predictable 9â€“5 routine', next: 'Q15', choice: 'A' },
            { text: 'Flexible hours/some structure', next: 'Q15', choice: 'B' },
            { text: 'Project-based/variable hours', next: 'Q15', choice: 'C' }
          ]
        },
        'Q15': {
          text: 'Stress tolerance in high-pressure settings:',
          options: [
            { text: 'Thrive under pressure', next: 'RESULT', choice: 'A' },
            { text: 'Manage pressure, prefer predictability', next: 'RESULT', choice: 'B' },
            { text: 'Prefer calm/minimal stress', next: 'RESULT', choice: 'C' }
          ]
        }
      };

      // --- 2. DEFINE QUIZ RESULTS (from Full Results Table) ---
      // This maps the named codes from the table to the result data.
      const resultsData = {
        'Realistic-Construction + Low-Extraversion + Structured + Low-Neuroticism': { careers: 'Carpenter, Electrician, Plumber, Construction Inspector', description: 'Technical trades, independent work', education: 'Certification, Apprenticeship', salary: '$50k-$70k', environment: 'Field, Structured' },
        'Realistic-Mechanical + Low-Extraversion + Structured + Low-Neuroticism': { careers: 'Automotive Technician, Aircraft Mechanic', description: 'Mechanical repair, technical expertise', education: 'Certification, Associate', salary: '$45k-$75k', environment: 'Workshop/Field' },
        'Realistic-Nature + Low-Extraversion + Flexible + Moderate-Neuroticism': { careers: 'Forest Ranger, Wildlife Biologist', description: 'Nature, animals, outdoors', education: 'Associate/Bachelor\'s', salary: '$40k-$65k', environment: 'Outdoors, Variable' },
        'Realistic-Technical + Moderate-Extraversion + Flexible + Low-Neuroticism': { careers: 'Engineering Tech, Surveyor', description: 'Team, technical collaboration', education: 'Technical Cert./Assoc.', salary: '$55k-$80k', environment: 'Lab/Field' },
        'Investigative-Life + High-Openness + Structured + Low-Neuroticism': { careers: 'Medical Researcher, Geneticist', description: 'Life sciences, research', education: 'MS/PhD', salary: '$80k-$120k', environment: 'Academic/Lab' },
        'Investigative-Physical + High-Openness + Flexible + Low-Neuroticism': { careers: 'Physicist, Chemist', description: 'Physical science, theory', education: 'PhD', salary: '$85k-$135k', environment: 'Lab/Univ.' },
        'Investigative-Data + High-Openness + Autonomous + Low-Neuroticism': { careers: 'Data Scientist, Actuary', description: 'Data, programming', education: 'BS/MS', salary: '$90k-$150k', environment: 'Tech/Remote' },
        'Investigative-Social + Moderate-Openness + Flexible + Moderate-Neuroticism': { careers: 'Psychologist, Sociologist', description: 'Human behavior, analysis', education: 'MS/PhD', salary: '$70k-$100k', environment: 'Univ./Corporate' },
        'Artistic-Visual + High-Openness + Autonomous + Moderate-Neuroticism': { careers: 'Fine Artist, Photographer', description: 'Creative expression', education: 'BA or Portfolio', salary: '$45k-$85k', environment: 'Studio/Freelance' },
        'Artistic-Writing + Moderate-Openness + Flexible + Moderate-Neuroticism': { careers: 'Writer, Journalist', description: 'Writing, content', education: 'BA', salary: '$50k-$80k', environment: 'Remote/Deadlines' },
        'Artistic-Performance + High-Openness + Autonomous + Low-Neuroticism': { careers: 'Actor, Musician', description: 'Live performance', education: 'Training/BA', salary: '$40k-$75k', environment: 'Theatre/Studio' },
        'Artistic-Design + Low-Openness + Structured + Moderate-Neuroticism': { careers: 'Graphic/UX Designer', description: 'Commercial design', education: 'BA', salary: '$55k-$90k', environment: 'Design Firm' },
        'Social-Healthcare + High-Agreeableness + Structured + Low-Neuroticism': { careers: 'Nurse, Therapist', description: 'Healthcare, patient care', education: 'Assoc./MS', salary: '$60k-$110k', environment: 'Clinic/Hospital' },
        'Social-Education + High-Agreeableness + Structured + Moderate-Neuroticism': { careers: 'Teacher, Professor', description: 'Teaching, education', education: 'BA/PhD', salary: '$50k-$85k', environment: 'School/Univ.' },
        'Social-Counseling + High-Agreeableness + Flexible + High-Neuroticism': { careers: 'Counselor, Social Worker', description: 'Therapy, advocacy', education: 'MS/Licensure', salary: '$45k-$75k', environment: 'School/Practice' },
        'Social-Community + Moderate-Agreeableness + Flexible + Moderate-Neuroticism': { careers: 'Community Organizer', description: 'Advocacy, nonprofit', education: 'BA/MS', salary: '$40k-$70k', environment: 'Nonprofit/Field' },
        'Enterprising-Sales + High-Extraversion + Autonomous + Low-Neuroticism': { careers: 'Sales Executive, Realtor', description: 'Sales, client mgt', education: 'BA', salary: '$55k-$120k+', environment: 'Field/Meetings' },
        'Enterprising-Management + Moderate-Extraversion + Structured + Low-Neuroticism': { careers: 'Project Manager, HR Manager', description: 'Team mgmt, ops', education: 'BA/MBA', salary: '$70k-$120k', environment: 'Office/Corp.' },
        'Enterprising-Entrepreneur + High-Extraversion + Autonomous + Low-Neuroticism': { careers: 'Startup Founder, Consultant', description: 'Business building', education: 'Variable', salary: 'Highly variable', environment: 'Self-directed' },
        'Enterprising-Marketing + High-Extraversion + Flexible + Low-Neuroticism': { careers: 'Brand Strategist, PR Manager', description: 'Marketing, comms', education: 'BA', salary: '$65k-$110k', environment: 'Agency/In-house' },
        'Conventional-Finance + High-Conscientiousness + Structured + Low-Neuroticism': { careers: 'Accountant, Auditor', description: 'Accounting, finance', education: 'BA/CPA', salary: '$70k-$95k', environment: 'Office, Deadline' },
        'Conventional-Admin + Moderate-Conscientiousness + Structured + Moderate-Neuroticism': { careers: 'Office Manager, Admin Coordinator', description: 'Support, coordination', education: 'Assoc./BA', salary: '$40k-$65k', environment: 'Office' },
        'Conventional-Data + High-Conscientiousness + Structured + Moderate-Neuroticism': { careers: 'Database Admin, Records Manager', description: 'Data mgmt, records', education: 'Assoc./BA', salary: '$50k-$85k', environment: 'Office' },
        'Conventional-Legal + High-Conscientiousness + Structured + Low-Neuroticism': { careers: 'Paralegal, Compliance Officer', description: 'Legal, regulatory', education: 'Assoc./BA', salary: '$50k-$80k', environment: 'Law Firm/Corp.' }
      };

      // --- 3. QUIZ STATE & DOM ELEMENTS ---
      let currentPath = []; // Stores answers as an array of objects
      let currentQuestionId = 'Q1';

      const quizBox = document.getElementById('quiz-box');
      const resultsBox = document.getElementById('results-box');
      const questionTextEl = document.getElementById('quiz-question-text');
      const optionsContainerEl = document.getElementById('quiz-options-container');
      const restartQuizBtn = document.getElementById('restart-quiz-btn');
      
      // Loading and results content elements
      const loadingSpinner = document.getElementById('loading-spinner');
      const loadingText = document.getElementById('loading-text');
      const resultsContent = document.getElementById('results-content');
      const resultsTitleText = document.getElementById('results-title-text');
      

      // --- 4. QUIZ LOGIC FUNCTIONS ---

      /**
       * Loads and displays a new question.
       */
      function loadQuestion(questionId) {
        const question = questions[questionId];
        if (!question) {
          console.error(`Question ${questionId} not found!`);
          return;
        }

        questionTextEl.textContent = question.text;
        optionsContainerEl.innerHTML = ''; // Clear old options

        question.options.forEach(option => {
          const button = document.createElement('button');
          button.type = 'button';
          button.className = 'option-btn';
          button.textContent = option.text;
          button.onclick = () => handleAnswerClick(questionId, question.text, option.choice, option.text, option.next);
          optionsContainerEl.appendChild(button);
        });
      }

      /**
       * Handles an answer click, stores the path, and navigates.
       */
      function handleAnswerClick(questionId, questionText, choice, answerText, nextStep) {
        // Store the full answer details
        currentPath.push({
          id: questionId,
          question: questionText,
          choice: choice,
          answer: answerText
        });

        if (nextStep === 'RESULT') {
          // End of the quiz, calculate and show results
          showResult();
        } else {
          // Go to the next question
          currentQuestionId = nextStep;
          loadQuestion(currentQuestionId);
        }
      }

      /**
       * Calculates the result based on the stored path and displays it.
       */
      async function showResult() {
        // Hide quiz, show results box
        quizBox.style.display = 'none';
        resultsBox.style.display = 'block';

        // Set up loading state
        loadingSpinner.style.display = 'block';
        loadingText.style.display = 'block';
        resultsContent.style.display = 'none';
        restartQuizBtn.disabled = true;
        restartQuizBtn.textContent = 'Analyzing...';
        resultsTitleText.textContent = 'Analyzing Your Profile';

        // This is the complex part: mapping the path to the result code
        const resultCode = getResultCodeFromPath(currentPath);
        const baseResult = resultsData[resultCode] || { // Fallback
          careers: 'Generalist / Explorer',
          description: 'You have a well-rounded set of interests!',
          education: 'Varies by Field',
          salary: 'Varies by Field',
          environment: 'Varies by Field'
        };

        try {
          // Call the Gemini API to get a concrete result
          const aiResult = await callGeminiApi(currentPath, baseResult);
          
          // Populate results elements with AI-powered data
          populateResults(aiResult);

        } catch (error) {
          console.error('Error calling Gemini API:', error);
          // If API fails, show the base result
          populateResults(baseResult, "We couldn't get an AI analysis, but here is your base profile:");
        } finally {
          // Hide loading state, show content
          loadingSpinner.style.display = 'none';
          loadingText.style.display = 'none';
          resultsContent.style.display = 'block';
          restartQuizBtn.disabled = false;
          restartQuizBtn.textContent = 'Take Quiz Again';
          resultsTitleText.textContent = 'Your Career Profile';
        }
      }
      
      /**
       * Helper to populate the results card
       */
      function populateResults(result, subtitle = null) {
        if (subtitle) {
          document.getElementById('results-subtitle-text').textContent = subtitle;
        } else {
          document.getElementById('results-subtitle-text').textContent = "Based on your answers, here is a career path that matches your interests:";
        }
        document.getElementById('results-careers-text').textContent = result.careers;
        document.getElementById('results-description-text').textContent = result.description;
        document.getElementById('results-education-text').textContent = result.education;
        document.getElementById('results-salary-text').textContent = result.salary;
        document.getElementById('results-environment-text').textContent = result.environment;
      }
      
      /**
       * Resets the quiz to the beginning.
       */
      function restartQuiz() {
          currentPath = [];
          currentQuestionId = 'Q1';
          resultsBox.style.display = 'none';
          quizBox.style.display = 'block';
          loadQuestion(currentQuestionId);
      }
      
      // Add listener for restart button
      restartQuizBtn.addEventListener('click', restartQuiz);

      /**
       * This is the core logic that maps the user's path (e.g., {Q1: 'A', Q2: 'B', ...})
       * to the named key in the resultsData object (e.g., "Realistic-Mechanical...").
       */
      function getResultCodeFromPath(path) {
        // Helper to find a choice by question ID
        const getChoice = (id) => path.find(p => p.id === id)?.choice;

        // --- Q15: Stress (Neuroticism) ---
        let p15_neuroticism = '';
        const q15_choice = getChoice('Q15');
        if (q15_choice === 'A') p15_neuroticism = 'Low-Neuroticism';
        else if (q15_choice === 'B') p15_neuroticism = 'Moderate-Neuroticism';
        else if (q15_choice === 'C') p15_neuroticism = 'High-Neuroticism'; // Mapping "Prefer calm" to High-N for "Social-Counseling"

        // --- Q14: Schedule (Structured) ---
        let p14_structure = '';
        const q14_choice = getChoice('Q14');
        if (q14_choice === 'A') p14_structure = 'Structured';
        else if (q14_choice === 'B') p14_structure = 'Flexible';
        else if (q14_choice === 'C') p14_structure = 'Autonomous'; // Mapping project-based to autonomous

        // --- PATH A: Realistic ---
        const q1_choice = getChoice('Q1');
        const q2_choice = getChoice('Q2');
        if (q1_choice === 'A') {
          let p2_domain = q2_choice === 'A' ? 'Construction' : q2_choice === 'B' ? 'Mechanical' : q2_choice === 'C' ? 'Nature' : 'Technical';
          let p8_extraversion = getChoice('Q8') === 'A' ? 'Low-Extraversion' : getChoice('Q8') === 'B' ? 'Moderate-Extraversion' : 'High-Extraversion';
          // Fix for "Realistic-Nature" (Q2:C) which uses Flexible+Moderate
          if (q2_choice === 'C') return 'Realistic-Nature + Low-Extraversion + Flexible + Moderate-Neuroticism';
          // Fix for "Realistic-Technical" (Q2:D)
          if (q2_choice === 'D') return 'Realistic-Technical + Moderate-Extraversion + Flexible + Low-Neuroticism';
          return `Realistic-${p2_domain} + ${p8_extraversion} + ${p14_structure} + ${p15_neuroticism}`;
        }
        
        // --- PATH B: Investigative ---
        const q3_choice = getChoice('Q3');
        if (q1_choice === 'B') {
          let p3_domain = q3_choice === 'A' ? 'Life' : q3_choice === 'B' ? 'Physical' : q3_choice === 'C' ? 'Data' : 'Social';
          let p9_openness = getChoice('Q9') === 'A' ? 'Low-Openness' : getChoice('Q9') === 'B' ? 'Moderate-Openness' : 'High-Openness';
          // Fix for "Investigative-Data" (Q3:C) which uses Autonomous
          if (q3_choice === 'C') return 'Investigative-Data + High-Openness + Autonomous + Low-Neuroticism';
          return `Investigative-${p3_domain} + ${p9_openness} + ${p14_structure} + ${p15_neuroticism}`;
        }
        
        // --- PATH C: Artistic ---
        const q4_choice = getChoice('Q4');
        if (q1_choice === 'C') {
          let p4_domain = q4_choice === 'A' ? 'Visual' : q4_choice === 'B' ? 'Writing' : q4_choice === 'C' ? 'Performance' : 'Design';
          let p10_openness = getChoice('Q10') === 'A' ? 'Low-Openness' : getChoice('Q10') === 'B' ? 'Moderate-Openness' : 'High-Openness';
          // Fix for "Artistic-Design" (Q4:D)
          if (q4_choice === 'D') return 'Artistic-Design + Low-Openness + Structured + Moderate-Neuroticism';
          return `Artistic-${p4_domain} + ${p10_openness} + ${p14_structure} + ${p15_neuroticism}`;
        }
        
        // --- PATH D: Social ---
        const q5_choice = getChoice('Q5');
        if (q1_choice === 'D') {
          let p5_domain = q5_choice === 'A' ? 'Healthcare' : q5_choice === 'B' ? 'Education' : q5_choice === 'C' ? 'Counseling' : 'Community';
          let p11_agree = getChoice('Q11') === 'A' ? 'Low-Agreeableness' : getChoice('Q11') === 'B' ? 'Moderate-Agreeableness' : 'High-Agreeableness';
          // Fix for "Social-Counseling" (Q5:C) which uses Flexible+High
          if (q5_choice === 'C' && p15_neuroticism === 'High-Neuroticism') return 'Social-Counseling + High-Agreeableness + Flexible + High-Neuroticism';
          return `Social-${p5_domain} + ${p11_agree} + Structured + ${p15_neuroticism}`; // Defaulting to Structured for Q11 paths
        }
        
        // --- PATH E: Enterprising ---
        const q6_choice = getChoice('Q6');
        if (q1_choice === 'E') {
          let p6_domain = q6_choice === 'A' ? 'Sales' : q6_choice === 'B' ? 'Management' : q6_choice === 'C' ? 'Entrepreneur' : 'Marketing';
          let p12_extra = getChoice('Q12') === 'A' ? 'Low-Extraversion' : getChoice('Q12') === 'B' ? 'Moderate-Extraversion' : 'High-Extraversion';
          // Fix for "Enterprising-Entrepreneur" (Q6:C)
          if (q6_choice === 'C') return 'Enterprising-Entrepreneur + High-Extraversion + Autonomous + Low-Neuroticism';
          // Fix for "Enterprising-Sales" (Q6:A)
          if (q6_choice === 'A') return 'Enterprising-Sales + High-Extraversion + Autonomous + Low-Neuroticism';
          // Fix for "Enterprising-Marketing" (Q6:D)
          if (q6_choice === 'D') return 'Enterprising-Marketing + High-Extraversion + Flexible + Low-Neuroticism';
          return `Enterprising-${p6_domain} + ${p12_extra} + Structured + ${p15_neuroticism}`; // Defaulting to Structured
        }
        
        // --- PATH F: Conventional ---
        const q7_choice = getChoice('Q7');
        if (q1_choice === 'F') {
          let p7_domain = q7_choice === 'A' ? 'Finance' : q7_choice === 'B' ? 'Admin' : q7_choice === 'C' ? 'Data' : 'Legal';
          let p13_consc = getChoice('Q13') === 'A' ? 'Low-Conscientiousness' : getChoice('Q13') === 'B' ? 'Moderate-Conscientiousness' : 'High-Conscientiousness';
          return `Conventional-${p7_domain} + ${p13_consc} + Structured + ${p15_neuroticism}`; // Defaulting to Structured
        }

        return null; // Fallback
      }

      // --- 5. GEMINI API CALL FUNCTION ---
      
      /**
       * Calls the Gemini API to get a concrete, AI-powered result.
       */
      async function callGeminiApi(answerPath, baseResult) {
        
        // Format the user's answers for the prompt
        const userAnswers = answerPath.map(p => `Q: ${p.question}\nA: ${p.answer}`).join('\n\n');
        
        const systemPrompt = "You are a professional career counselor. A student has just completed a career quiz. Their answers are provided.";

        const userPrompt = `
          Here are the student's answers:
          ${userAnswers}

          Based on this path, the quiz algorithm produced the following base result:
          - Careers: "${baseResult.careers}"
          - Description: "${baseResult.description}"
          - Education: "${baseResult.education}"
          - Median Salary: "${baseResult.salary}"
          - Work Environment: "${baseResult.environment}"

          Your task is to analyze the user's specific answers and refine this base result into a concrete JSON object.
          Pay close attention to fields that say "Varies" or "Highly variable". Use the user's answers (e.g., their preference for "Entrepreneurship") to provide a specific, realistic, and concrete estimate for these fields.
          For example, for an "Entrepreneur" path, "Education" could be "Bachelor's/MBA recommended" and "Median Salary" could be an estimated range like "$80k - $250k+".

          Provide *only* the final JSON object, matching this exact schema. Do not include \`\`\`json or any other text.
        `;

        // Define the JSON schema we expect in return
        const schema = {
          type: "OBJECT",
          properties: {
            "careers": { "type": "STRING" },
            "description": { "type": "STRING" },
            "education": { "type": "STRING" },
            "salary": { "type": "STRING" },
            "environment": { "type": "STRING" }
          },
          required: ["careers", "description", "education", "salary", "environment"]
        };

        const payload = {
          contents: [{ parts: [{ text: userPrompt }] }],
          systemInstruction: {
            parts: [{ text: systemPrompt }]
          },
          generationConfig: {
            responseMimeType: "application/json",
            responseSchema: schema,
            temperature: 0.5,
          }
        };

        // --- Fetch with Exponential Backoff ---
        let response;
        let delay = 1000;
        for (let i = 0; i < 5; i++) { // Retry up to 5 times
          try {
            response = await fetch(apiUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });

            if (response.ok) {
              const result = await response.json();
              const candidate = result.candidates?.[0];
              
              if (candidate && candidate.content?.parts?.[0]?.text) {
                // The API returns the JSON as a string in the 'text' field
                return JSON.parse(candidate.content.parts[0].text);
              } else {
                throw new Error('Invalid API response structure');
              }
            } else if (response.status === 429 || response.status >= 500) {
              // Throttling or server error, wait and retry
              await new Promise(resolve => setTimeout(resolve, delay));
              delay *= 2;
            } else {
              // Other client-side error, don't retry
              throw new Error(`API Error: ${response.status} ${response.statusText}`);
            }
          } catch (error) {
            console.error(`Attempt ${i+1} failed:`, error);
            if (i === 4) throw error; // Re-throw after last attempt
            await new Promise(resolve => setTimeout(resolve, delay));
            delay *= 2;
          }
        }
      }

      // --- 6. START THE QUIZ ---
      loadQuestion(currentQuestionId);
    });
  </script>
</body>
</html>