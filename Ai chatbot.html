<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Chatbot | CONNEX</title>
  <!-- Google Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    /* --- CSS Reset --- */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* --- Base & Theme Background (Same as job-search) --- */
    body {
      font-family: 'Inter', sans-serif;
      background-color: #0a192f;
      background-image:
        radial-gradient(circle at 15% 25%, rgba(42, 92, 199, 0.3) 0%, rgba(42, 92, 199, 0) 40%),
        radial-gradient(circle at 85% 75%, rgba(42, 92, 199, 0.3) 0%, rgba(42, 92, 199, 0) 40%),
        radial-gradient(rgba(255, 255, 255, 0.04) 1px, transparent 1px);
      background-size: 100% 100%, 100% 100%, 10px 10px;
      background-attachment: fixed;
      color: #ffffff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
      width: 100%;
    }

    /* --- Navbar (Same as job-search) --- */
    .navbar {
      background: rgba(10, 25, 47, 0.5);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 1rem 0;
      position: sticky;
      top: 0;
      z-index: 1000;
      width: 100%;
    }
    .navbar .container {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo h1 { margin: 0; }
    .logo a {
      font-size: 1.5rem;
      font-weight: 700;
      color: #ffffff;
      text-decoration: none;
    }
    .nav-links {
      display: flex;
      list-style: none;
      gap: 1.5rem;
    }
    .nav-links a {
      color: #e0e0e0;
      text-decoration: none;
      font-weight: 500;
      transition: color 0.3s ease;
    }
    .nav-links a:hover { color: #ffffff; }
    .btn-primary {
      background-color: #007aff;
      color: #ffffff;
      text-decoration: none;
      padding: 0.6rem 1.2rem;
      border-radius: 8px;
      font-weight: 600;
      transition: background-color 0.3s ease;
    }
    .btn-primary:hover { background-color: #0056b3; }

    /* --- Main Content --- */
    main {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      width: 100%;
    }

    /* --- Hero Title (Same as job-search) --- */
    .dashboard-hero {
      text-align: center;
      padding: 2.5rem 0;
    }
    .dashboard-title {
      font-size: 2.5rem;
      font-weight: 700;
      color: #ffffff;
      margin-bottom: 0.5rem;
    }
    .dashboard-tagline {
      font-size: 1.1rem;
      color: #c5c5c5;
      font-weight: 400;
      max-width: 600px;
      margin: 0 auto;
      line-height: 1.6;
    }

    /* --- Chatbot Layout --- */
    .chat-container {
      max-width: 800px;
      margin: 0 auto 2rem auto; /* Added bottom margin */
      width: 100%;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      padding: 0 1rem;
    }

    .chat-messages {
      flex-grow: 1;
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      /* Glassmorphism for the chat log */
      background: rgba(25, 41, 70, 0.35);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
      border-radius: 16px 16px 0 0; /* Rounded top */
      min-height: 400px;
    }
    
    .message {
      padding: 0.8rem 1.2rem;
      border-radius: 12px;
      max-width: 80%;
      line-height: 1.5;
      word-wrap: break-word;
    }
    
    .message.user {
      background-color: #007aff;
      color: #ffffff;
      align-self: flex-end;
      border-radius: 12px 12px 0 12px;
    }
    
    .message.bot {
      background-color: rgba(255, 255, 255, 0.1);
      color: #e0e0e0;
      align-self: flex-start;
      border-radius: 12px 12px 12px 0;
    }

    .message.bot.loading {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    /* Loading dots animation */
    .loading-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: #a0a0a0;
      animation: bounce 1.4s infinite both;
    }
    .loading-dot:nth-child(2) { animation-delay: 0.16s; }
    .loading-dot:nth-child(3) { animation-delay: 0.32s; }
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1.0); }
    }
    
    .message .sources {
      margin-top: 1rem;
      padding-top: 0.75rem;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    .sources h4 {
      font-size: 0.8rem;
      color: #c5c5c5;
      margin-bottom: 0.5rem;
    }
    .sources ol {
      padding-left: 1rem;
      font-size: 0.8rem;
    }
    .sources a {
      color: #ade8ff;
      text-decoration: none;
    }
    .sources a:hover {
      text-decoration: underline;
    }
    

    /* --- Chat Input Bar --- */
    .chat-input-bar {
      display: flex;
      /* Glassmorphism for input bar */
      background: rgba(25, 41, 70, 0.5);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-top: none;
      border-radius: 0 0 16px 16px; /* Rounded bottom */
      padding: 0.75rem;
    }
    
    #chat-input {
      flex-grow: 1;
      font-size: 1rem;
      padding: 0.8rem 1rem;
      background: rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #ffffff;
      border-radius: 8px 0 0 8px;
      outline: none;
    }
    #chat-input::placeholder { color: #a0a0a0; }
    
    #send-button {
      font-size: 1rem;
      padding: 0.8rem 1.2rem;
      font-weight: 600;
      color: #ffffff;
      background-color: #007aff;
      border: none;
      border-radius: 0 8px 8px 0;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    #send-button:hover { background-color: #0056b3; }
    #send-button:disabled {
      background-color: #555;
      cursor: not-allowed;
    }

    /* --- Footer (Same as job-search) --- */
    .footer {
      padding: 2rem 0;
      background: rgba(10, 25, 47, 0.3);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      color: #c5c5c5;
    }
    .footer-content {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 2rem;
    }
    .footer-section h3 {
      font-size: 1.2rem;
      font-weight: 600;
      color: #ffffff;
      margin-bottom: 1rem;
    }
    .footer-section p { max-width: 300px; }
    .footer-section h4 {
      font-size: 1rem;
      font-weight: 600;
      color: #ffffff;
      margin-bottom: 1rem;
    }
    .footer-section ul { list-style: none; }
    .footer-section li { margin-bottom: 0.5rem; }
    .footer-section a {
      color: #c5c5c5;
      text-decoration: none;
      transition: color 0.3s ease;
    }
    .footer-section a:hover { color: #ffffff; }
    .footer-bottom {
      text-align: center;
      padding-top: 2rem;
      margin-top: 2rem;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* --- Responsive (Mobile) --- */
    @media (max-width: 768px) {
      .navbar .container {
        flex-direction: column;
        gap: 1rem;
      }
      .nav-links {
        justify-content: center;
        width: 100%;
      }
      .dashboard-title { font-size: 2rem; }
      .dashboard-tagline { font-size: 1rem; }
      .footer-content {
        flex-direction: column;
        text-align: center;
      }
      .footer-section p { margin: 0 auto; }
    }
  </style>
</head>
<body>

  <!-- Navigation Bar -->
  <nav class="navbar">
    <div class="container">
        <div class="logo">
            <h1><a href="Student-dashboard.html" class="logo">CONNEX</a></h1>
        </div>
        <ul class="nav-links">
          <li><a href="Student-dashboard.html">Home</a></li>
          <li><a href="#premium">Premium</a></li>
        </ul>
        <div class="cta-button">
            <a href="account.html" class="btn-primary">Account</a>
        </div>
    </div>
  </nav>

  <!-- Main Chat Content -->
  <main>
    <section class="dashboard-hero">
      <div class="container">
        <h1 class="dashboard-title">Ask CONNEX AI</h1>
        <p class="dashboard-tagline">Ask anything about the job market. Our AI chatbot trained with real-time market data will answer all your queries.</p>
      </div>
    </section>

    <div class="chat-container">
      <div class="chat-messages" id="chat-messages">
        <!-- Example bot welcome message -->
        <div class="message bot">
          Hello! I'm the CONNEX AI assistant. How can I help you with your career or job search today?
        </div>
      </div>
      <div class="chat-input-bar">
        <input type="text" id="chat-input" placeholder="Ask about resumes, interviews, or market trends...">
        <button id="send-button">Send</button>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
        <div class="footer-content">
            <div class="footer-section">
                <h3>CONNEX</h3>
                <p>Building bridges between students and professionals.</p>
            </div>
            <div class="footer-section">
                <h4>Quick Links</h4>
                <ul>
                    <li><a href="#home">Home</a></li>
                    <li><a href="#about">About</a></li>
                    <li><a href="#how-it-works">How It Works</a></li>
                    <li><a href="#contact">Contact</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h4>Project by:</h4>
                <ul>
                    <li>Hitendra Annavarapu</li>
                    <li>Mahadi Ibrahim</li>
                    <li>Quin Curry</li>
                    <li>Charan Suguri</li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2025 CONNEX Platform - Alpha 2. All rights reserved.</p>
        </div>
    </div>
  </footer>

  <!-- JAVASCRIPT TO POWER THE CHATBOT -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Get chat elements
      const chatMessages = document.getElementById('chat-messages');
      const chatInput = document.getElementById('chat-input');
      const sendButton = document.getElementById('send-button');

      // --- Add event listeners ---
      sendButton.addEventListener('click', sendMessage);
      chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          sendMessage();
        }
      });

      // --- System instruction for the bot ---
      const systemPrompt = `You are CONNEX, an expert AI assistant for students and recruiters, specializing in the job market, career advice, and skill building. You are trained with real-time market data.
      Keep your answers concise, professional, and helpful.
      Format your responses using simple markdown (bold, italics, lists) for readability.
      You MUST NOT answer questions unrelated to jobs, careers, education, or professional development.`;
      
      /**
       * Adds a new message to the chat log
       * @param {string} text - The message text
       * @param {string} sender - 'user' or 'bot'
       * @returns {HTMLElement} - The message element that was just added
       */
      function addMessageToLog(text, sender) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('message', sender);
        
        // A simple markdown-to-HTML converter
        let html = text
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold
          .replace(/\*(.*?)\*/g, '<em>$1</em>')     // Italics
          .replace(/\n\* (.*)/g, '<ul><li>$1</li></ul>') // Basic lists
          .replace(/<\/ul><ul>/g, ''); // Fix for consecutive list items
          
        messageElement.innerHTML = html;
        chatMessages.appendChild(messageElement);
        
        // Scroll to the bottom
        chatMessages.scrollTop = chatMessages.scrollHeight;
        return messageElement;
      }

      /**
       * Shows the "bot is typing..." loading indicator
       */
      function showLoadingIndicator() {
        const loadingElement = document.createElement('div');
        loadingElement.classList.add('message', 'bot', 'loading');
        loadingElement.id = 'loading-indicator';
        loadingElement.innerHTML = `
          <div class="loading-dot"></div>
          <div class="loading-dot"></div>
          <div class="loading-dot"></div>
        `;
        chatMessages.appendChild(loadingElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      /**
       * Removes the "bot is typing..." loading indicator
       */
      function hideLoadingIndicator() {
        const loadingElement = document.getElementById('loading-indicator');
        if (loadingElement) {
          chatMessages.removeChild(loadingElement);
        }
      }
      
      /**
       * Formats and appends source citations to a bot message
       * @param {HTMLElement} botMessageElement - The bot's message bubble
       * @param {Array} sources - The array of source objects from groundingMetadata
       */
      function appendSources(botMessageElement, sources) {
        if (!sources || sources.length === 0) {
          return;
        }

        const sourcesContainer = document.createElement('div');
        sourcesContainer.classList.add('sources');
        
        let sourcesHtml = '<h4>Sources:</h4><ol>';
        sources.forEach((source, index) => {
          sourcesHtml += `<li><a href="${source.uri}" target="_blank">${source.title || 'Source ' + (index + 1)}</a></li>`;
        });
        sourcesHtml += '</ol>';
        
        sourcesContainer.innerHTML = sourcesHtml;
        botMessageElement.appendChild(sourcesContainer);
      }

      /**
       * Main function to handle sending a message
       */
      async function sendMessage() {
        const userQuery = chatInput.value.trim();
        if (!userQuery) return;

        // Disable input while processing
        chatInput.value = '';
        chatInput.disabled = true;
        sendButton.disabled = true;

        // 1. Add user's message to log
        addMessageToLog(userQuery, 'user');

        // 2. Show loading indicator
        showLoadingIndicator();

        try {
          // 3. Call the Gemini API
          const { text, sources } = await callGeminiApi(userQuery);
          
          // 4. Hide loading and show bot's response
          hideLoadingIndicator();
          const botMessageElement = addMessageToLog(text, 'bot');
          
          // 5. Add sources, if any
          appendSources(botMessageElement, sources);

        } catch (error) {
          // Handle errors
          hideLoadingIndicator();
          addMessageToLog('Sorry, I ran into an error. Please try again.', 'bot');
        }

        // Re-enable input
        chatInput.disabled = false;
        sendButton.disabled = false;
        chatInput.focus();
      }

      /**
       * Calls the Gemini API with retry logic
       * @param {string} userQuery - The user's prompt
       * @returns {Promise<{text: string, sources: Array}>} - The bot's response text and sources
       */
      async function callGeminiApi(userQuery) {
        // IMPORTANT: The API key is an empty string. The Canvas environment
        // will securely provide the key at runtime. DO NOT PASTE YOUR KEY HERE.
        const apiKey = "AIzaSyD7yff-vHibNIRAS5UuaXnL-qLOQEuOoBk"; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // Payload with grounding (Google Search) enabled
        const payload = {
          contents: [{ parts: [{ text: userQuery }] }],
          tools: [{ "google_search": {} }],
          systemInstruction: {
            parts: [{ text: systemPrompt }]
          },
        };

        let response;
        let retries = 3;
        let delay = 1000; // 1 second

        // Retry logic with exponential backoff
        for (let i = 0; i < retries; i++) {
          try {
            response = await fetch(apiUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });

            if (response.ok) {
              const result = await response.json();
              const candidate = result.candidates?.[0];

              if (candidate && candidate.content?.parts?.[0]?.text) {
                // 1. Extract the generated text
                const text = candidate.content.parts[0].text;

                // 2. Extract grounding sources
                let sources = [];
                const groundingMetadata = candidate.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri); // Ensure sources are valid
                }
                
                return { text, sources };
              } else {
                throw new Error('Invalid API response structure');
              }
            } else if (response.status === 429 || response.status >= 500) {
              // Throttling or server error, wait and retry
              await new Promise(resolve => setTimeout(resolve, delay));
              delay *= 2; // Exponential backoff
            } else {
              // Other client-side error, don't retry
              const errorResult = await response.json();
              console.error('API Error:', errorResult);
              throw new Error(errorResult.error?.message || `HTTP error! status: ${response.status}`);
            }
          } catch (error) {
            if (i === retries - 1) {
              // Last retry failed
              console.error('API call failed after retries:', error);
              throw new Error('API call failed. Please try again later.');
            }
            // Wait before retrying
            await new Promise(resolve => setTimeout(resolve, delay));
            delay *= 2;
          }
        }
        
        throw new Error('API call failed after all retries.');
      }
    });
  </script>
</body>
</html>